<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Materi - KelasOnline</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/forms.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>KelasOnline</span>
            </div>
            <div class="nav-menu">
                <a href="dashboard-dosen.html" class="nav-link">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="kelas-dosen.html" class="nav-link active">
                    <i class="fas fa-chalkboard"></i> Kelas Saya
                </a>
                <a href="#" class="nav-link">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </a>
                <div class="nav-profile">
                    <img src="https://ui-avatars.com/api/?name=Dosen&background=2563EB&color=fff" alt="Profile">
                    <div class="profile-dropdown">
                        <a href="profil-dosen.html"><i class="fas fa-user"></i> Profil</a>
                        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="dashboard-container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="dashboard-dosen.html"><i class="fas fa-home"></i> Dashboard</a>
            <span>/</span>
            <a href="detail-kelas-dosen.html">Pemrograman Web</a>
            <span>/</span>
            <span class="active">Kelola Materi</span>
        </div>

        <!-- Header -->
        <section class="page-header glass-effect">
            <div class="header-content">
                <h1><i class="fas fa-book"></i> Kelola Materi</h1>
                <p>Pemrograman Web - Semester 5</p>
            </div>
            <button class="btn-primary" onclick="openModalMateri()">
                <i class="fas fa-plus"></i> Tambah Materi
            </button>
        </section>

        <!-- Filter Section -->
        <section class="filter-section glass-effect">
            <div class="filter-group">
                <label><i class="fas fa-filter"></i> Filter:</label>
                <select id="filterPertemuan" class="form-control-sm" onchange="filterMateri()">
                    <option value="">Semua Pertemuan</option>
                    <option value="1">Pertemuan 1</option>
                    <option value="2">Pertemuan 2</option>
                    <option value="3">Pertemuan 3</option>
                    <option value="4">Pertemuan 4</option>
                    <option value="5">Pertemuan 5</option>
                    <option value="6">Pertemuan 6</option>
                    <option value="7">Pertemuan 7</option>
                    <option value="8">Pertemuan 8</option>
                </select>
                <select id="filterTipe" class="form-control-sm" onchange="filterMateri()">
                    <option value="">Semua Tipe</option>
                    <option value="pdf">PDF</option>
                    <option value="video">Video</option>
                </select>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Cari materi..." id="searchMateri" onkeyup="searchMateri()">
            </div>
        </section>

        <!-- Materi List -->
        <section class="materi-container">
            <div class="materi-grid" id="materiList">
                <!-- Materi Card 1 -->
                <div class="materi-card glass-effect" data-pertemuan="1" data-tipe="pdf">
                    <div class="materi-header">
                        <div class="materi-type-badge pdf">
                            <i class="fas fa-file-pdf"></i> PDF
                        </div>
                        <div class="materi-menu">
                            <i class="fas fa-ellipsis-v"></i>
                            <div class="dropdown-menu">
                                <a href="#" onclick="viewMateri(1)"><i class="fas fa-eye"></i> Lihat</a>
                                <a href="#" onclick="downloadMateri(1)"><i class="fas fa-download"></i> Download</a>
                                <a href="#" onclick="editMateri(1)"><i class="fas fa-edit"></i> Edit</a>
                                <a href="#" onclick="deleteMateri(1)" class="text-danger"><i class="fas fa-trash"></i> Hapus</a>
                            </div>
                        </div>
                    </div>
                    <div class="materi-icon-large">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="materi-content">
                        <span class="materi-pertemuan">Pertemuan 1</span>
                        <h3 class="materi-title">Pengenalan HTML5</h3>
                        <p class="materi-description">Materi dasar HTML5, struktur dokumen, dan semantic elements</p>
                    </div>
                    <div class="materi-meta">
                        <span><i class="fas fa-calendar"></i> 05 Sep 2024</span>
                        <span><i class="fas fa-download"></i> 28 downloads</span>
                        <span><i class="fas fa-file"></i> 2.5 MB</span>
                    </div>
                </div>

                <!-- Materi Card 2 -->
                <div class="materi-card glass-effect" data-pertemuan="2" data-tipe="video">
                    <div class="materi-header">
                        <div class="materi-type-badge video">
                            <i class="fas fa-video"></i> VIDEO
                        </div>
                        <div class="materi-menu">
                            <i class="fas fa-ellipsis-v"></i>
                            <div class="dropdown-menu">
                                <a href="#" onclick="viewMateri(2)"><i class="fas fa-eye"></i> Lihat</a>
                                <a href="#" onclick="editMateri(2)"><i class="fas fa-edit"></i> Edit</a>
                                <a href="#" onclick="deleteMateri(2)" class="text-danger"><i class="fas fa-trash"></i> Hapus</a>
                            </div>
                        </div>
                    </div>
                    <div class="materi-icon-large video">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="materi-content">
                        <span class="materi-pertemuan">Pertemuan 2</span>
                        <h3 class="materi-title">CSS Styling & Layout</h3>
                        <p class="materi-description">Video tutorial CSS dasar, selectors, dan layout flexbox</p>
                    </div>
                    <div class="materi-meta">
                        <span><i class="fas fa-calendar"></i> 12 Sep 2024</span>
                        <span><i class="fas fa-eye"></i> 25 views</span>
                        <span><i class="fas fa-clock"></i> 45 menit</span>
                    </div>
                </div>

                <!-- Materi Card 3 -->
                <div class="materi-card glass-effect" data-pertemuan="3" data-tipe="pdf">
                    <div class="materi-header">
                        <div class="materi-type-badge pdf">
                            <i class="fas fa-file-pdf"></i> PDF
                        </div>
                        <div class="materi-menu">
                            <i class="fas fa-ellipsis-v"></i>
                            <div class="dropdown-menu">
                                <a href="#" onclick="viewMateri(3)"><i class="fas fa-eye"></i> Lihat</a>
                                <a href="#" onclick="downloadMateri(3)"><i class="fas fa-download"></i> Download</a>
                                <a href="#" onclick="editMateri(3)"><i class="fas fa-edit"></i> Edit</a>
                                <a href="#" onclick="deleteMateri(3)" class="text-danger"><i class="fas fa-trash"></i> Hapus</a>
                            </div>
                        </div>
                    </div>
                    <div class="materi-icon-large">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="materi-content">
                        <span class="materi-pertemuan">Pertemuan 3</span>
                        <h3 class="materi-title">JavaScript Fundamentals</h3>
                        <p class="materi-description">Dasar pemrograman JavaScript, variables, dan functions</p>
                    </div>
                    <div class="materi-meta">
                        <span><i class="fas fa-calendar"></i> 19 Sep 2024</span>
                        <span><i class="fas fa-download"></i> 22 downloads</span>
                        <span><i class="fas fa-file"></i> 3.1 MB</span>
                    </div>
                </div>

                <!-- Materi Card 4 -->
                <div class="materi-card glass-effect" data-pertemuan="4" data-tipe="video">
                    <div class="materi-header">
                        <div class="materi-type-badge video">
                            <i class="fas fa-video"></i> VIDEO
                        </div>
                        <div class="materi-menu">
                            <i class="fas fa-ellipsis-v"></i>
                            <div class="dropdown-menu">
                                <a href="#" onclick="viewMateri(4)"><i class="fas fa-eye"></i> Lihat</a>
                                <a href="#" onclick="editMateri(4)"><i class="fas fa-edit"></i> Edit</a>
                                <a href="#" onclick="deleteMateri(4)" class="text-danger"><i class="fas fa-trash"></i> Hapus</a>
                            </div>
                        </div>
                    </div>
                    <div class="materi-icon-large video">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="materi-content">
                        <span class="materi-pertemuan">Pertemuan 4</span>
                        <h3 class="materi-title">DOM Manipulation</h3>
                        <p class="materi-description">Tutorial manipulasi DOM dengan JavaScript</p>
                    </div>
                    <div class="materi-meta">
                        <span><i class="fas fa-calendar"></i> 26 Sep 2024</span>
                        <span><i class="fas fa-eye"></i> 18 views</span>
                        <span><i class="fas fa-clock"></i> 60 menit</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Add/Edit Materi -->
    <div id="modalMateri" class="modal">
        <div class="modal-content glass-effect modal-large">
            <div class="modal-header">
                <h2 id="modalTitle">
                    <i class="fas fa-plus-circle"></i>
                    Tambah Materi Baru
                </h2>
                <button class="modal-close" onclick="closeModalMateri()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="formMateri" onsubmit="submitMateri(event)">
                <div class="modal-body">
                    <!-- Tabs for PDF/Video -->
                    <div class="tabs-mini">
                        <button type="button" class="tab-btn active" data-tab="pdf" onclick="switchMateriType('pdf')">
                            <i class="fas fa-file-pdf"></i> Upload PDF
                        </button>
                        <button type="button" class="tab-btn" data-tab="video" onclick="switchMateriType('video')">
                            <i class="fas fa-video"></i> Link Video
                        </button>
                    </div>

                    <!-- Common Fields -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="judulMateri">
                                <i class="fas fa-heading"></i> Judul Materi *
                            </label>
                            <input type="text" id="judulMateri" class="form-control" 
                                   placeholder="Contoh: Pengenalan HTML5" required>
                        </div>
                        <div class="form-group">
                            <label for="pertemuanKe">
                                <i class="fas fa-calendar-week"></i> Pertemuan Ke *
                            </label>
                            <select id="pertemuanKe" class="form-control" required>
                                <option value="">Pilih Pertemuan</option>
                                <option value="1">Pertemuan 1</option>
                                <option value="2">Pertemuan 2</option>
                                <option value="3">Pertemuan 3</option>
                                <option value="4">Pertemuan 4</option>
                                <option value="5">Pertemuan 5</option>
                                <option value="6">Pertemuan 6</option>
                                <option value="7">Pertemuan 7</option>
                                <option value="8">Pertemuan 8</option>
                                <option value="9">Pertemuan 9</option>
                                <option value="10">Pertemuan 10</option>
                                <option value="11">Pertemuan 11</option>
                                <option value="12">Pertemuan 12</option>
                                <option value="13">Pertemuan 13</option>
                                <option value="14">Pertemuan 14</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="deskripsiMateri">
                            <i class="fas fa-align-left"></i> Deskripsi
                        </label>
                        <textarea id="deskripsiMateri" class="form-control" rows="3" 
                                  placeholder="Deskripsi singkat tentang materi..."></textarea>
                    </div>

                    <!-- PDF Upload Section -->
                    <div id="pdfSection" class="materi-type-section active">
                        <div class="form-group">
                            <label>
                                <i class="fas fa-file-pdf"></i> Upload File PDF *
                            </label>
                            <div class="file-upload-area" id="pdfDropZone">
                                <input type="file" id="pdfFile" accept=".pdf" onchange="handleFileSelect(event)">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <p class="upload-text">
                                    <strong>Drag & drop file PDF di sini</strong><br>
                                    atau klik untuk memilih file
                                </p>
                                <p class="upload-hint">Format: PDF | Max: 10 MB</p>
                            </div>
                            <div id="pdfPreview" class="file-preview" style="display: none;">
                                <div class="preview-info">
                                    <i class="fas fa-file-pdf"></i>
                                    <span id="pdfFileName"></span>
                                    <span id="pdfFileSize"></span>
                                </div>
                                <button type="button" class="btn-remove" onclick="removeFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="progress-container" id="uploadProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressBar"></div>
                            </div>
                            <span class="progress-text" id="progressText">0%</span>
                        </div>
                    </div>

                    <!-- Video Link Section -->
                    <div id="videoSection" class="materi-type-section">
                        <div class="form-group">
                            <label for="videoUrl">
                                <i class="fas fa-link"></i> URL Video *
                            </label>
                            <input type="url" id="videoUrl" class="form-control" 
                                   placeholder="https://www.youtube.com/watch?v=...">
                            <small class="form-hint">
                                <i class="fas fa-info-circle"></i>
                                Support: YouTube, Google Drive, atau link video lainnya
                            </small>
                        </div>
                        <div class="video-preview" id="videoPreview" style="display: none;">
                            <iframe id="videoFrame" width="100%" height="315" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModalMateri()">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Simpan Materi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="../assets/js/validation.js"></script>
    <script src="../assets/js/ui-interactions.js"></script>
    <script src="../assets/js/file-upload-handler.js"></script>
    <script>
        let currentMateriId = null;
        let isEditMode = false;
        let currentMateriType = 'pdf';

        // Open Modal
        function openModalMateri() {
            isEditMode = false;
            currentMateriType = 'pdf';
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Tambah Materi Baru';
            document.getElementById('formMateri').reset();
            switchMateriType('pdf');
            document.getElementById('modalMateri').classList.add('active');
        }

        // Close Modal
        function closeModalMateri() {
            document.getElementById('modalMateri').classList.remove('active');
            document.getElementById('formMateri').reset();
            removeFile();
        }

        // Switch Materi Type (PDF/Video)
        function switchMateriType(type) {
            currentMateriType = type;
            
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${type}"]`).classList.add('active');
            
            // Show/hide sections
            document.getElementById('pdfSection').classList.toggle('active', type === 'pdf');
            document.getElementById('videoSection').classList.toggle('active', type === 'video');
            
            // Update required fields
            const pdfFile = document.getElementById('pdfFile');
            const videoUrl = document.getElementById('videoUrl');
            
            if (type === 'pdf') {
                pdfFile.required = true;
                videoUrl.required = false;
            } else {
                pdfFile.required = false;
                videoUrl.required = true;
            }
        }

        // Handle File Select
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                if (file.type !== 'application/pdf') {
                    showToast('File harus berformat PDF!', 'error');
                    event.target.value = '';
                    return;
                }
                
                // Validate file size (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('Ukuran file maksimal 10 MB!', 'error');
                    event.target.value = '';
                    return;
                }
                
                // Show preview
                document.getElementById('pdfDropZone').style.display = 'none';
                document.getElementById('pdfPreview').style.display = 'flex';
                document.getElementById('pdfFileName').textContent = file.name;
                document.getElementById('pdfFileSize').textContent = formatFileSize(file.size);
            }
        }

        // Remove File
        function removeFile() {
            document.getElementById('pdfFile').value = '';
            document.getElementById('pdfDropZone').style.display = 'flex';
            document.getElementById('pdfPreview').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
        }

        // Format File Size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
            else return (bytes / 1048576).toFixed(2) + ' MB';
        }

        // Submit Form
        function submitMateri(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('judul', document.getElementById('judulMateri').value);
            formData.append('pertemuan_ke', document.getElementById('pertemuanKe').value);
            formData.append('deskripsi', document.getElementById('deskripsiMateri').value);
            formData.append('tipe', currentMateriType);
            
            if (currentMateriType === 'pdf') {
                const file = document.getElementById('pdfFile').files[0];
                if (file) {
                    formData.append('file', file);
                    // Simulate upload progress
                    simulateUpload();
                }
            } else {
                formData.append('video_url', document.getElementById('videoUrl').value);
            }
            
            // TODO: Send to backend
            console.log('Form data:', Object.fromEntries(formData));
            
            setTimeout(() => {
                showToast('Materi berhasil ditambahkan!', 'success');
                closeModalMateri();
                location.reload();
            }, 2000);
        }

        // Simulate Upload Progress
        function simulateUpload() {
            document.getElementById('uploadProgress').style.display = 'block';
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 200);
        }

        // View Materi
        function viewMateri(id) {
            // TODO: Open materi in new tab or modal
            showToast('Membuka materi...', 'info');
        }

        // Download Materi
        function downloadMateri(id) {
            // TODO: Download file
            showToast('Mengunduh materi...', 'info');
        }

        // Edit Materi
        function editMateri(id) {
            isEditMode = true;
            currentMateriId = id;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Materi';
            
            // TODO: Load data from backend
            document.getElementById('judulMateri').value = 'Pengenalan HTML5';
            document.getElementById('pertemuanKe').value = '1';
            document.getElementById('deskripsiMateri').value = 'Materi dasar HTML5';
            
            document.getElementById('modalMateri').classList.add('active');
        }

        // Delete Materi
        function deleteMateri(id) {
            if (confirm('Apakah Anda yakin ingin menghapus materi ini?')) {
                // TODO: Call backend
                showToast('Materi berhasil dihapus', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }

        // Filter Materi
        function filterMateri() {
            const pertemuan = document.getElementById('filterPertemuan').value;
            const tipe = document.getElementById('filterTipe').value;
            const cards = document.querySelectorAll('.materi-card');
            
            cards.forEach(card => {
                const cardPertemuan = card.getAttribute('data-pertemuan');
                const cardTipe = card.getAttribute('data-tipe');
                
                const matchPertemuan = !pertemuan || cardPertemuan === pertemuan;
                const matchTipe = !tipe || cardTipe === tipe;
                
                card.style.display = matchPertemuan && matchTipe ? 'block' : 'none';
            });
        }

        // Search Materi
        function searchMateri() {
            const input = document.getElementById('searchMateri').value.toUpperCase();
            const cards = document.querySelectorAll('.materi-card');
            
            cards.forEach(card => {
                const title = card.querySelector('.materi-title').textContent.toUpperCase();
                const desc = card.querySelector('.materi-description').textContent.toUpperCase();
                
                if (title.indexOf(input) > -1 || desc.indexOf(input) > -1) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Show Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} active`;
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // Drag & Drop
        const dropZone = document.getElementById('pdfDropZone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            }, false);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('pdfFile').files = files;
            handleFileSelect({ target: { files: files } });
        }, false);

        // Video URL Preview
        document.getElementById('videoUrl').addEventListener('input', (e) => {
            const url = e.target.value;
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = extractYouTubeID(url);
                if (videoId) {
                    const iframe = document.getElementById('videoFrame');
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    document.getElementById('videoPreview').style.display = 'block';
                }
            }
        });

        function extractYouTubeID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('modalMateri');
            if (event.target === modal) {
                closeModalMateri();
            }
        }
    </script>
</body>
</html>

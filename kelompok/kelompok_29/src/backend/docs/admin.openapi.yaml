openapi: 3.0.3
info:
  title: SIPINDA Admin API
  version: '1.0.0'
  description: >-
    Blueprint endpoint Admin (A2 Dashboard & A3 Manajemen Tiket) untuk REST API
    Vanilla PHP SIPINDA.
servers:
  - url: /api
security:
  - BearerAuth: []
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ErrorDetail:
      type: object
      properties:
        field:
          type: string
          nullable: true
        reason:
          type: string
          nullable: true
        message:
          type: string
      additionalProperties: false
    BaseResponse:
      type: object
      required: [status, code, message, data, errors]
      properties:
        status:
          type: string
          enum: [success, error]
        code:
          type: integer
        message:
          type: string
        data:
          type: object
          nullable: true
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'
          default: []
    ComplaintStatus:
      type: string
      enum:
        - diajukan
        - diverifikasi_admin
        - ditugaskan_ke_petugas
        - dalam_proses
        - menunggu_validasi_admin
        - selesai
    DashboardStatsData:
      type: object
      required: [total, baru, in_progress, finished]
      properties:
        total:
          type: integer
          minimum: 0
        baru:
          type: integer
          minimum: 0
        in_progress:
          type: integer
          minimum: 0
        finished:
          type: integer
          minimum: 0
    DashboardStatsResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/DashboardStatsData'
    ActivityRecord:
      type: object
      required: [complaint_id, title, status, reporter, activity_time]
      properties:
        complaint_id:
          type: integer
        title:
          type: string
        status:
          $ref: '#/components/schemas/ComplaintStatus'
        reporter:
          type: object
          required: [name, email]
          properties:
            name:
              type: string
            email:
              type: string
        activity_time:
          type: string
          format: date-time
    RecentActivitiesData:
      type: object
      required: [limit, records]
      properties:
        limit:
          type: integer
          minimum: 1
        records:
          type: array
          items:
            $ref: '#/components/schemas/ActivityRecord'
    RecentActivitiesResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/RecentActivitiesData'
    TicketReporter:
      type: object
      required: [id, name, email]
      properties:
        id:
          type: integer
        name:
          type: string
        email:
          type: string
    TicketRecord:
      type: object
      required: [id, title, status, category, address, reporter, created_at]
      properties:
        id:
          type: integer
        title:
          type: string
        status:
          $ref: '#/components/schemas/ComplaintStatus'
        category:
          type: string
        address:
          type: string
        reporter:
          $ref: '#/components/schemas/TicketReporter'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
          nullable: true
    TicketListData:
      type: object
      required: [page, limit, total_data, total_page, filters, records]
      properties:
        page:
          type: integer
          minimum: 1
        limit:
          type: integer
          minimum: 1
          maximum: 50
        total_data:
          type: integer
          minimum: 0
        total_page:
          type: integer
          minimum: 0
        filters:
          type: object
          properties:
            status:
              $ref: '#/components/schemas/ComplaintStatus'
            search:
              type: string
              nullable: true
          additionalProperties: false
        records:
          type: array
          items:
            $ref: '#/components/schemas/TicketRecord'
    TicketListResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/TicketListData'
    TicketLocation:
      type: object
      properties:
        latitude:
          type: number
          format: float
          nullable: true
        longitude:
          type: number
          format: float
          nullable: true
    TicketTimelineItem:
      type: object
      required: [id, status, note, created_at, created_by]
      properties:
        id:
          type: integer
        status:
          $ref: '#/components/schemas/ComplaintStatus'
        note:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by:
          type: object
          required: [id, name]
          properties:
            id:
              type: integer
            name:
              type: string
    CompletionProofItem:
      type: object
      required: [id, photo, submitted_at, officer]
      properties:
        id:
          type: integer
        photo:
          type: string
        notes:
          type: string
          nullable: true
        submitted_at:
          type: string
          format: date-time
        officer:
          type: object
          required: [id, name]
          properties:
            id:
              type: integer
            name:
              type: string
    TicketDetail:
      type: object
      required: [id, title, description, category, status, address, created_at]
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        category:
          type: string
        status:
          $ref: '#/components/schemas/ComplaintStatus'
        address:
          type: string
        photo_before:
          type: string
          nullable: true
        photo_after:
          type: string
          nullable: true
        location:
          $ref: '#/components/schemas/TicketLocation'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
          nullable: true
    TicketDetailData:
      type: object
      required: [ticket, reporter, timeline, completion_proofs]
      properties:
        ticket:
          $ref: '#/components/schemas/TicketDetail'
        reporter:
          $ref: '#/components/schemas/TicketReporter'
        officer:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            employee_id:
              type: string
            name:
              type: string
            email:
              type: string
            department:
              type: string
            specialization:
              type: string
        timeline:
          type: array
          items:
            $ref: '#/components/schemas/TicketTimelineItem'
        completion_proofs:
          type: array
          items:
            $ref: '#/components/schemas/CompletionProofItem'
    TicketDetailResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/TicketDetailData'
    OfficerAvailabilityRecord:
      type: object
      required: [id, employee_id, name, email, department, specialization, active_tasks, capacity_left]
      properties:
        id:
          type: integer
        employee_id:
          type: string
        name:
          type: string
        email:
          type: string
        department:
          type: string
        specialization:
          type: string
        active_tasks:
          type: integer
        capacity_left:
          type: integer
    OfficerAvailabilityResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              required: [max_active_tasks, records]
              properties:
                max_active_tasks:
                  type: integer
                records:
                  type: array
                  items:
                    $ref: '#/components/schemas/OfficerAvailabilityRecord'
    AssignOfficerRequest:
      type: object
      required: [officer_id]
      properties:
        officer_id:
          type: integer
    RejectTicketRequest:
      type: object
      required: [reason]
      properties:
        reason:
          type: string
    ValidateTicketRequest:
      type: object
      properties:
        note:
          type: string
          nullable: true
paths:
  /admin/dashboard/stats:
    get:
      operationId: api-a2-01-dashboard-stats
      summary: API-A2-01 Statistik Dashboard Admin
      description: Hitung total laporan berdasarkan status terbaru.
      tags: [Dashboard Admin]
      responses:
        '200':
          description: Statistik berhasil dikembalikan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardStatsResponse'
              examples:
                sukses:
                  value:
                    status: success
                    code: 200
                    message: Statistik dashboard admin berhasil diambil.
                    data:
                      total: 120
                      baru: 15
                      in_progress: 42
                      finished: 63
                    errors: []
        '401':
          description: Token tidak valid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
              examples:
                unauthorized:
                  value:
                    status: error
                    code: 401
                    message: Token tidak dikenali.
                    data: []
                    errors:
                      - reason: missing_token
        '500':
          description: Kesalahan server saat query statistik.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
              examples:
                server_error:
                  value:
                    status: error
                    code: 500
                    message: Gagal memuat statistik dashboard.
                    data: []
                    errors:
                      - reason: db_error
  /admin/dashboard/recent-activities:
    get:
      operationId: api-a2-02-dashboard-recent
      summary: API-A2-02 Aktivitas Laporan Terbaru
      description: Ambil riwayat aktivitas 10 laporan terbaru (dapat ubah limit).
      tags: [Dashboard Admin]
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 25
            default: 10
          description: Jumlah aktivitas yang ingin ditampilkan.
      responses:
        '200':
          description: Daftar aktivitas berhasil dikembalikan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecentActivitiesResponse'
              examples:
                sukses:
                  value:
                    status: success
                    code: 200
                    message: Aktivitas terbaru berhasil diambil.
                    data:
                      limit: 10
                      records:
                        - complaint_id: 87
                          title: Lampu jalan padam
                          status: dalam_proses
                          reporter:
                            name: Adi Pranata
                            email: adi@mail.com
                          activity_time: '2025-01-12T09:21:00Z'
                    errors: []
        '401':
          description: Token tidak valid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
              examples:
                unauthorized:
                  value:
                    status: error
                    code: 401
                    message: Token tidak dikenali.
                    data: []
                    errors:
                      - reason: missing_token
        '500':
          description: Kesalahan server saat query aktivitas.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
              examples:
                server_error:
                  value:
                    status: error
                    code: 500
                    message: Gagal memuat aktivitas terbaru.
                    data: []
                    errors:
                      - reason: db_error
  /admin/tickets:
    get:
      operationId: api-a3-01-ticket-list
      summary: API-A3-01/02/03 Daftar, Filter, & Pencarian Tiket
      description: >-
        Mengambil daftar pengaduan dengan dukungan pagination, filter status,
        dan pencarian kata kunci (menggantikan endpoint search terpisah).
      tags: [Tickets]
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Nomor halaman.
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 15
          description: Jumlah data per halaman.
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/ComplaintStatus'
          description: Filter status (6 status alur valid).
        - in: query
          name: search
          schema:
            type: string
          description: Kata kunci untuk mencari judul, nama/email pelapor, atau ID tiket.
      responses:
        '200':
          description: Daftar tiket sesuai filter/pagination.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketListResponse'
              examples:
                sukses:
                  value:
                    status: success
                    code: 200
                    message: Daftar tiket berhasil dimuat.
                    data:
                      page: 1
                      limit: 15
                      total_data: 120
                      total_page: 8
                      filters:
                        status: dalam_proses
                        search: lampu
                      records:
                        - id: 32
                          title: Jalan berlubang besar
                          status: dalam_proses
                          category: Jalan_Raya
                          address: 'Jl. Kenanga No. 2'
                          reporter:
                            id: 7
                            name: Riska Dewi
                            email: riska@mail.com
                          created_at: '2025-01-10T07:30:00Z'
                          updated_at: '2025-01-12T14:11:00Z'
                    errors: []
        '422':
          description: Status filter tidak valid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
              examples:
                invalid_status:
                  value:
                    status: error
                    code: 422
                    message: Status tidak valid.
                    data: []
                    errors:
                      - field: status
                        reason: invalid_status
                        message: Status tidak dikenali.
                empty_search:
                  value:
                    status: error
                    code: 422
                    message: Parameter pencarian tidak boleh kosong.
                    data: []
                    errors:
                      - field: search
                        reason: empty_search
                        message: Kata kunci wajib diisi.
        '404':
          description: Tidak ada tiket yang cocok untuk kata kunci tertentu.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
              examples:
                not_found:
                  value:
                    status: error
                    code: 404
                    message: Tiket tidak ditemukan.
                    data: []
                    errors:
                      - field: search
                        reason: no_match
        '401':
          description: Token tidak valid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '500':
          description: Kesalahan server saat query daftar tiket.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
  /admin/tickets/{id}:
    get:
      operationId: api-a4-01-ticket-detail
      summary: API-A4-01 Detail Tiket
      description: Ambil informasi lengkap tiket, pelapor, penugasan, timeline, dan bukti penyelesaian.
      tags: [Admin Tickets]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID tiket pengaduan.
      responses:
        '200':
          description: Detail tiket ditemukan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketDetailResponse'
              examples:
                sukses:
                  value:
                    status: success
                    code: 200
                    message: Detail tiket berhasil diambil.
                    data:
                      ticket:
                        id: 42
                        title: Lampu jalan padam
                        description: Lampu utama kawasan rusak
                        category: Penerangan_Jalan
                        status: menunggu_validasi_admin
                        address: 'Jl. Kenanga No. 2'
                        photo_before: uploads/complaints/photo.jpg
                        photo_after: null
                        location:
                          latitude: -6.2
                          longitude: 106.8
                        created_at: '2025-01-10T09:00:00Z'
                        updated_at: '2025-01-15T11:00:00Z'
                      reporter:
                        id: 7
                        name: Riska Dewi
                        email: riska@mail.com
                        phone: '08123456789'
                      officer:
                        id: 3
                        employee_id: OFF-003
                        name: Dedi Pratama
                        email: dedi@pemkot.go.id
                        department: PUPR
                        specialization: Penerangan_Jalan
                      timeline: []
                      completion_proofs: []
                    errors: []
        '404':
          description: Tiket tidak ditemukan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '400':
          description: ID tidak valid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '500':
          description: Kesalahan server.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
  /admin/tickets/{id}/verify:
    post:
      operationId: api-a4-02-ticket-verify
      summary: API-A4-02 Verifikasi Tiket
      description: Ubah status tiket dari diajukan menjadi diverifikasi_admin dan simpan log status.
      tags: [Admin Tickets]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Tiket berhasil diverifikasi.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
              examples:
                sukses:
                  value:
                    status: success
                    code: 200
                    message: Status tiket diperbarui menjadi diverifikasi.
                    data:
                      ticket_id: 42
                      status: diverifikasi_admin
                    errors: []
        '409':
          description: Status tiket tidak diajukan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '404':
          description: Tiket tidak ditemukan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '500':
          description: Kesalahan server.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
  /admin/tickets/{id}/reject:
    post:
      operationId: api-a4-03-ticket-reject
      summary: API-A4-03 Tolak Tiket
      description: Tandai tiket sebagai ditolak_admin dengan alasan opsional (wajib bila diisi).
      tags: [Admin Tickets]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RejectTicketRequest'
            examples:
              default:
                value:
                  reason: Laporan tidak lengkap (foto kabur).
      responses:
        '200':
          description: Tiket berhasil ditolak.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '422':
          description: Alasan kosong.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '409':
          description: Status tidak mendukung penolakan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '404':
          description: Tiket tidak ditemukan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '500':
          description: Kesalahan server.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
  /admin/officers/available:
    get:
      operationId: api-a4-04-officer-available
      summary: API-A4-04 Daftar Petugas Tersedia
      description: Ambil daftar petugas dengan status tersedia dan jumlah tiket aktif di bawah kapasitas.
      tags: [Admin Tickets]
      responses:
        '200':
          description: Daftar petugas tersedia.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfficerAvailabilityResponse'
        '500':
          description: Kesalahan server.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
  /admin/tickets/{id}/assign-officer:
    post:
      operationId: api-a4-05-assign-officer
      summary: API-A4-05 Penugasan Petugas
      description: Tunjuk petugas untuk tiket berstatus diverifikasi_admin dan ubah status menjadi ditugaskan_ke_petugas.
      tags: [Admin Tickets]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignOfficerRequest'
            examples:
              default:
                value:
                  officer_id: 5
      responses:
        '200':
          description: Petugas berhasil ditugaskan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '409':
          description: Status tiket belum diverifikasi atau petugas penuh.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '404':
          description: Tiket atau petugas tidak ditemukan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '422':
          description: officer_id tidak valid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '500':
          description: Kesalahan server.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
  /admin/tickets/{id}/proof:
    get:
      operationId: api-a4-06-proof
      summary: API-A4-06 Bukti Penyelesaian
      description: Menampilkan daftar foto/catatan bukti dari petugas ketika status minimal menunggu_validasi_admin.
      tags: [Admin Tickets]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Bukti tersedia.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '404':
          description: Bukti belum diunggah.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '409':
          description: Status tiket belum memasuki validasi.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '500':
          description: Kesalahan server.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
  /admin/tickets/{id}/validate:
    post:
      operationId: api-a4-07-validate
      summary: API-A4-07 Validasi Penyelesaian
      description: Mengubah status tiket dari menunggu_validasi_admin menjadi selesai dan menutup penugasan.
      tags: [Admin Tickets]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateTicketRequest'
            examples:
              default:
                value:
                  note: Validasi lapangan selesai.
      responses:
        '200':
          description: Tiket diselesaikan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '409':
          description: Status tiket belum menunggu validasi.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '404':
          description: Tiket tidak ditemukan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'
        '500':
          description: Kesalahan server.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BaseResponse'

name: Auto Tag & Release on Merge

on:
  pull_request_target:
    types: [closed]
    branches: [master]

permissions:
  contents: write

jobs:
  create_tag_and_release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Take kelompok label
        id: label
        run: |
          LABEL=$(echo '${{ toJson(github.event.pull_request.labels) }}' | grep -oi 'kelompok-[0-9][0-9]' | head -n 1)

          if [ -z "$LABEL" ]; then
            echo "Label kelompok tidak ditemukan. Pastikan PR memiliki label kelompok-XX."
            exit 1
          fi

          echo "label=$LABEL" >> $GITHUB_OUTPUT
          echo "Label ditemukan: $LABEL"

      - name: Find README in kelompok folder (case-insensitive)
        id: folder
        run: |
          NUMBER=$(echo "${{ steps.label.outputs.label }}" | grep -o '[0-9][0-9]')
          DIR="kelompok/kelompok_${NUMBER}"

          if [ ! -d "$DIR" ]; then
            echo "Folder tidak ditemukan: $DIR"
            exit 1
          fi

          README_PATH=$(find "$DIR" -maxdepth 1 -type f -iname "readme.md" | head -n 1)

          if [ -z "$README_PATH" ]; then
            echo "README tidak ditemukan di $DIR (README.md / readme.md / Readme.md)"
            exit 1
          fi

          echo "readme=$README_PATH" >> $GITHUB_OUTPUT
          echo "README ditemukan: $README_PATH"

      - name: Read README Content (release notes)
        id: notes
        run: |
          CONTENT=$(cat "${{ steps.folder.outputs.readme }}")

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Make tag name
        id: tag
        run: |
          LABEL="${{ steps.label.outputs.label }}"
          DATE=$(date +"%Y%m%d")
          TAG="${LABEL}-submission-${DATE}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Tag dibuat: $TAG"

      - name: Create Git Tag
        run: |
          TAG="${{ steps.tag.outputs.tag }}"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Release ${{ steps.tag.outputs.tag }}"
          body: ${{ steps.notes.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success
        run: |
          echo "Release ${{ steps.tag.outputs.tag }} berhasil dibuat."
